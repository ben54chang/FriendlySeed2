# 角色管理系統

## 1. 系統架構

### 1.1 技術架構
- **後端框架**: ASP.NET Core 8.0 MVC
- **資料庫**: Microsoft SQL Server
- **ORM**: Dapper
- **前端UI**: LTEAdmin 3.2 + Bootstrap 4
- **JavaScript庫**: jQuery, DataTables, Toastr, SweetAlert2
- **認證方式**: Cookie Authentication
- **資料庫操作**: Store Procedure (sp_CreateRoleWithMenus, sp_UpdateRoleWithMenus)

### 1.2 專案結構
```
FriendlySeed/
├── Areas/
│   └── Admin/
│       ├── Controllers/
│       │   └── RoleController.cs
│       └── Views/
│           └── Role/
│               └── Index.cshtml
├── Models/
│   ├── Role.cs
│   └── MenuRole.cs
├── Services/
│   ├── IRoleService.cs
│   ├── RoleService.cs
│   ├── IMenuRoleService.cs
│   └── MenuRoleService.cs
└── Database/
    ├── sp_CreateRoleWithMenus.sql
    └── sp_UpdateRoleWithMenus.sql
```

## 2. 功能需求

### 2.1 基本功能
- **角色列表**: 顯示所有角色，支援分頁、搜尋、排序
- **角色新增**: 透過 Modal 彈出視窗新增角色
- **角色編輯**: 透過 Modal 彈出視窗編輯角色
- **角色刪除**: AJAX 刪除角色
- **狀態切換**: 啟用/停用角色狀態
- **選單權限**: 設定角色可存取的選單權限

### 2.2 進階功能
- **選單權限管理**: 使用 Checkbox 清單選擇選單權限
- **子選單限制**: 只能選擇子選單 (ParentID IS NOT NULL)
- **即時驗證**: 表單即時驗證
- **訊息提示**: 使用 Toastr 顯示操作結果
- **Store Procedure**: 使用資料庫 Store Procedure 確保資料一致性

### 2.3 權限控制
- **管理員認證**: 需要登入後台才能存取
- **操作記錄**: 記錄建立時間、更新時間
- **狀態管理**: 支援角色啟用/停用狀態
- **選單權限**: 角色與選單的多對多關聯

## 3. 資料表結構

### 3.1 Role 資料表
```sql
CREATE TABLE Role (
    RoleID INT IDENTITY(1,1) PRIMARY KEY,              -- 角色ID
    RoleName NVARCHAR(100) NOT NULL,                   -- 角色名稱
    IsActive BIT NOT NULL DEFAULT 1,                   -- 是否啟用
    CreatedTime DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 建立時間
    UpdatedTime DATETIME2 NOT NULL DEFAULT GETDATE()   -- 更新時間
);
```

### 3.2 MenuRole 資料表
```sql
CREATE TABLE MenuRole (
    MenuID INT NOT NULL,                               -- 選單ID
    RoleID INT NOT NULL,                               -- 角色ID
    IsActive BIT NOT NULL DEFAULT 1,                   -- 是否啟用
    CreatedTime DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 建立時間
    UpdatedTime DATETIME2 NOT NULL DEFAULT GETDATE(),  -- 更新時間
    PRIMARY KEY (MenuID, RoleID),                      -- 複合主鍵
    FOREIGN KEY (MenuID) REFERENCES Menu(MenuID),      -- 外鍵約束
    FOREIGN KEY (RoleID) REFERENCES Role(RoleID)       -- 外鍵約束
);
```

### 3.3 欄位說明

#### Role 資料表
| 欄位名稱 | 資料類型 | 是否必填 | 預設值 | 說明 |
|---------|---------|---------|--------|------|
| RoleID | INT | 是 | IDENTITY(1,1) | 主鍵，自動遞增 |
| RoleName | NVARCHAR(100) | 是 | - | 角色名稱 |
| IsActive | BIT | 是 | 1 | 是否啟用 |
| CreatedTime | DATETIME2 | 是 | GETDATE() | 建立時間 |
| UpdatedTime | DATETIME2 | 是 | GETDATE() | 更新時間 |

#### MenuRole 資料表
| 欄位名稱 | 資料類型 | 是否必填 | 預設值 | 說明 |
|---------|---------|---------|--------|------|
| MenuID | INT | 是 | - | 選單ID (外鍵) |
| RoleID | INT | 是 | - | 角色ID (外鍵) |
| IsActive | BIT | 是 | 1 | 是否啟用 |
| CreatedTime | DATETIME2 | 是 | GETDATE() | 建立時間 |
| UpdatedTime | DATETIME2 | 是 | GETDATE() | 更新時間 |

## 4. Store Procedure

### 4.1 sp_CreateRoleWithMenus
```sql
CREATE OR ALTER PROCEDURE sp_CreateRoleWithMenus
    @RoleName NVARCHAR(100),
    @IsActive BIT = 1,
    @MenuIds NVARCHAR(MAX), -- 逗號分隔的選單ID字串
    @NewRoleID INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- 1. 新增角色
        INSERT INTO Role (RoleName, IsActive, CreatedTime, UpdatedTime)
        VALUES (@RoleName, @IsActive, GETDATE(), GETDATE());
        
        -- 2. 取得新角色的 ID
        SET @NewRoleID = SCOPE_IDENTITY();
        
        -- 3. 設定選單權限
        IF @MenuIds IS NOT NULL AND LEN(LTRIM(RTRIM(@MenuIds))) > 0
        BEGIN
            INSERT INTO MenuRole (MenuID, RoleID, IsActive, CreatedTime, UpdatedTime)
            SELECT 
                CAST(value AS INT) as MenuID,
                @NewRoleID as RoleID,
                1 as IsActive,
                GETDATE() as CreatedTime,
                GETDATE() as UpdatedTime
            FROM STRING_SPLIT(@MenuIds, ',')
            WHERE LTRIM(RTRIM(value)) != '';
        END
        
        COMMIT TRANSACTION;
        SELECT 'SUCCESS' as Result, @NewRoleID as NewRoleID;
        
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
        SELECT 'ERROR' as Result, ERROR_MESSAGE() as Message;
    END CATCH
END
```

### 4.2 sp_UpdateRoleWithMenus
```sql
CREATE OR ALTER PROCEDURE sp_UpdateRoleWithMenus
    @RoleID INT,
    @RoleName NVARCHAR(100),
    @IsActive BIT = 1,
    @MenuIds NVARCHAR(MAX) -- 逗號分隔的選單ID字串
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- 1. 更新角色基本資料
        UPDATE Role 
        SET RoleName = @RoleName, 
            IsActive = @IsActive, 
            UpdatedTime = GETDATE()
        WHERE RoleID = @RoleID;
        
        -- 2. 先刪除現有的選單權限
        DELETE FROM MenuRole WHERE RoleID = @RoleID;
        
        -- 3. 插入新的選單權限
        IF @MenuIds IS NOT NULL AND LEN(LTRIM(RTRIM(@MenuIds))) > 0
        BEGIN
            INSERT INTO MenuRole (MenuID, RoleID, IsActive, CreatedTime, UpdatedTime)
            SELECT 
                CAST(value AS INT) as MenuID,
                @RoleID as RoleID,
                1 as IsActive,
                GETDATE() as CreatedTime,
                GETDATE() as UpdatedTime
            FROM STRING_SPLIT(@MenuIds, ',')
            WHERE LTRIM(RTRIM(value)) != '';
        END
        
        COMMIT TRANSACTION;
        SELECT 'SUCCESS' as Result, 'Role updated successfully' as Message;
        
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
        SELECT 'ERROR' as Result, ERROR_MESSAGE() as Message;
    END CATCH
END
```

## 5. 使用者介面需求

### 5.1 後台路徑
- **主要頁面**: `localhost:8054/Admin/Role`
- **認證要求**: 需要管理員登入

### 5.2 介面元件
- **UI框架**: LTEAdmin 3.2 + Bootstrap 4
- **資料表格**: DataTables (繁體中文介面)
- **彈出視窗**: Bootstrap Modal
- **選單權限**: Checkbox 清單
- **訊息提示**: Toastr
- **確認對話框**: SweetAlert2

### 5.3 功能按鈕
- **新增按鈕**: 開啟 Modal 新增角色
- **編輯按鈕**: 開啟 Modal 編輯角色
- **刪除按鈕**: AJAX 刪除角色
- **狀態切換**: 啟用/停用角色

### 5.4 選單權限選擇
- **顯示方式**: Checkbox 清單
- **選擇限制**: 只能選擇子選單 (ParentID IS NOT NULL)
- **多選支援**: 可同時選擇多個選單權限
- **即時顯示**: 編輯時顯示已選擇的權限

## 6. 驗收項目

### 6.1 基本功能驗收
- [ ] **角色列表顯示**
  - [ ] 正確顯示所有角色資料
  - [ ] 支援分頁功能
  - [ ] 支援搜尋功能
  - [ ] 支援欄位排序
  - [ ] 顯示繁體中文介面

- [ ] **角色新增功能**
  - [ ] Modal 彈出視窗正常開啟
  - [ ] 表單驗證正常運作
  - [ ] 必填欄位驗證 (角色名稱)
  - [ ] 選單權限選擇正常
  - [ ] 成功新增後顯示成功訊息
  - [ ] 新增後自動重新載入列表

- [ ] **角色編輯功能**
  - [ ] Modal 彈出視窗正常開啟
  - [ ] 正確載入現有資料
  - [ ] 正確顯示已選擇的選單權限
  - [ ] 表單驗證正常運作
  - [ ] 成功更新後顯示成功訊息
  - [ ] 更新後自動重新載入列表

- [ ] **角色刪除功能**
  - [ ] 確認對話框正常顯示
  - [ ] 成功刪除後顯示成功訊息
  - [ ] 刪除後自動重新載入列表

### 6.2 進階功能驗收
- [ ] **選單權限管理**
  - [ ] 只顯示子選單 (ParentID IS NOT NULL)
  - [ ] Checkbox 選擇正常運作
  - [ ] 多選功能正常
  - [ ] 編輯時正確顯示已選擇的權限

- [ ] **Store Procedure 功能**
  - [ ] 新增角色使用 Store Procedure
  - [ ] 更新角色使用 Store Procedure
  - [ ] 資料庫事務正常運作
  - [ ] 錯誤處理正常

- [ ] **狀態管理**
  - [ ] 啟用/停用狀態切換正常
  - [ ] 狀態顯示正確
  - [ ] 狀態變更後即時更新

### 6.3 使用者體驗驗收
- [ ] **介面響應性**
  - [ ] Modal 點擊背景不關閉
  - [ ] Modal 右上角關閉圖示正常
  - [ ] 載入狀態正確顯示
  - [ ] 錯誤訊息正確顯示

- [ ] **訊息提示**
  - [ ] 成功操作顯示綠色 Toastr
  - [ ] 錯誤操作顯示紅色 Toastr
  - [ ] 訊息內容正確
  - [ ] 訊息顯示時間適當 (1.5秒後重新載入)

- [ ] **資料驗證**
  - [ ] 前端即時驗證
  - [ ] 後端 ModelState 驗證
  - [ ] 錯誤訊息正確顯示
  - [ ] 必填欄位標示清楚

### 6.4 效能驗收
- [ ] **載入效能**
  - [ ] 頁面載入時間 < 3秒
  - [ ] DataTable 初始化正常
  - [ ] AJAX 請求回應時間 < 2秒

- [ ] **資料處理**
  - [ ] 大量資料分頁正常
  - [ ] 搜尋功能效能良好
  - [ ] 排序功能正常運作
  - [ ] Store Procedure 執行效能良好

### 6.5 安全性驗收
- [ ] **權限控制**
  - [ ] 未登入無法存取頁面
  - [ ] 登入後正常存取功能
  - [ ] 操作權限正確

- [ ] **資料安全**
  - [ ] CSRF Token 驗證
  - [ ] SQL Injection 防護
  - [ ] XSS 防護
  - [ ] Store Procedure 參數化查詢

## 7. 測試案例

### 7.1 功能測試
1. **新增角色測試**
   - 輸入完整資料新增角色
   - 輸入不完整資料測試驗證
   - 選擇選單權限測試
   - 不選擇選單權限測試

2. **編輯角色測試**
   - 修改角色名稱
   - 修改選單權限
   - 移除所有選單權限
   - 修改啟用狀態

3. **刪除角色測試**
   - 刪除單個角色
   - 確認對話框測試
   - 刪除後資料確認

### 7.2 選單權限測試
1. **權限選擇測試**
   - 只顯示子選單
   - 多選功能正常
   - 編輯時正確顯示已選擇的權限

2. **權限儲存測試**
   - 新增時儲存選單權限
   - 編輯時更新選單權限
   - 移除選單權限

### 7.3 Store Procedure 測試
1. **新增 Store Procedure 測試**
   - 正常新增角色和權限
   - 只新增角色不設定權限
   - 錯誤處理測試

2. **更新 Store Procedure 測試**
   - 正常更新角色和權限
   - 移除所有權限
   - 錯誤處理測試

### 7.4 介面測試
1. **Modal 測試**
   - 開啟/關閉 Modal
   - Modal 內容載入
   - 表單驗證顯示

2. **DataTable 測試**
   - 分頁功能
   - 搜尋功能
   - 排序功能

### 7.5 錯誤處理測試
1. **網路錯誤測試**
   - 網路中斷情況
   - 伺服器錯誤處理
   - 超時處理

2. **資料驗證測試**
   - 必填欄位測試
   - 字元長度測試
   - 選單權限驗證測試

## 8. 部署說明

### 8.1 環境需求
- .NET 8.0 Runtime
- Microsoft SQL Server
- IIS 或 Kestrel

### 8.2 資料庫設定
- 執行 Store Procedure 建立腳本
- 確保外鍵約束正確設定
- 檢查資料表權限

### 8.3 設定檔
- `appsettings.json`: 資料庫連線字串
- `Program.cs`: 服務註冊和中介軟體設定

## 9. 維護說明

### 9.1 定期維護
- 檢查角色資料完整性
- 檢查選單權限關聯
- 監控 Store Procedure 效能

### 9.2 常見問題
- 選單權限顯示問題
- Store Procedure 執行錯誤
- 資料庫連線問題

### 9.3 擴展功能
- 角色繼承功能
- 權限細分管理
- 角色使用統計

