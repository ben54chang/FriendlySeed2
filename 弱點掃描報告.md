# FriendlySeed 弱點掃描報告

## 掃描日期
2025-01-08

## 掃描範圍
- ASP.NET Core 8.0 Web 應用程式
- SQL Server 資料庫
- 身份驗證與授權機制
- 資料輸入驗證
- 敏感資料處理

---

## 🔴 高風險弱點

### 1. JWT 密鑰硬編碼
**風險等級**: 高
**位置**: `appsettings.json` 和 `appsettings.Production.json`
```json
"JwtSettings": {
  "SecretKey": "FriendlySeed_SecretKey_2024_ThisIsAVeryLongSecretKeyForJWTTokenGeneration"
}
```
**問題**: JWT 密鑰直接寫在設定檔中，容易被洩露
**建議**: 
- 使用環境變數或 Azure Key Vault
- 定期輪換密鑰
- 使用更強的密鑰生成方式

### 2. 資料庫連線字串安全性
**風險等級**: 高
**位置**: `appsettings.json`
```json
"ConnectionStrings": {
  "DefaultConnection": "Server=localhost;Database=FriendlySeed;Trusted_Connection=true;TrustServerCertificate=true;"
}
```
**問題**: 使用 Windows 驗證，但沒有加密連線
**建議**:
- 使用 SQL Server 加密連線
- 考慮使用 Azure SQL 或受管理的資料庫服務
- 實作連線字串加密

---

## 🟡 中風險弱點

### 3. 敏感資訊記錄
**風險等級**: 中
**位置**: `Services/RoleService.cs`
```csharp
Console.WriteLine($"Parameters: RoleName={role.RoleName}, IsActive={role.IsActive}");
Console.WriteLine($"MenuIds: {string.Join(",", menuIds ?? new List<int>())}");
```
**問題**: 在 Console 中記錄敏感資訊
**建議**:
- 移除或使用適當的日誌級別
- 避免記錄敏感資料
- 使用結構化日誌記錄

### 4. 缺少輸入驗證
**風險等級**: 中
**位置**: 多個控制器和服務
**問題**: 缺少對使用者輸入的完整驗證
**建議**:
- 實作 ModelState 驗證
- 使用 Data Annotations
- 加入自訂驗證規則

### 5. 錯誤資訊洩露
**風險等級**: 中
**位置**: `Program.cs`
```csharp
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}
```
**問題**: 生產環境錯誤處理可能洩露敏感資訊
**建議**:
- 實作自訂錯誤頁面
- 記錄錯誤但不向使用者顯示詳細資訊

---

## 🟢 低風險弱點

### 6. 缺少安全標頭
**風險等級**: 低
**問題**: 缺少重要的安全 HTTP 標頭
**建議**:
- 加入 Content Security Policy (CSP)
- 設定 X-Frame-Options
- 加入 X-Content-Type-Options
- 設定 Referrer-Policy

### 7. 會話管理
**風險等級**: 低
**位置**: `Program.cs`
```csharp
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});
```
**問題**: 缺少 Secure 和 SameSite 設定
**建議**:
- 加入 `options.Cookie.Secure = true` (HTTPS)
- 設定 `options.Cookie.SameSite = SameSiteMode.Strict`

---

## ✅ 安全優點

### 1. 密碼雜湊
- 使用 BCrypt 進行密碼雜湊 ✅
- 適當的密碼驗證機制 ✅

### 2. SQL 注入防護
- 使用 Dapper 參數化查詢 ✅
- 使用存儲過程 ✅

### 3. 身份驗證
- 實作 Cookie 認證 ✅
- 適當的會話超時設定 ✅

---

## 🔧 修復建議優先順序

### 立即修復 (高優先級)
1. **移除硬編碼的 JWT 密鑰**
2. **加密資料庫連線**
3. **移除敏感資訊記錄**

### 短期修復 (中優先級)
1. **加強輸入驗證**
2. **改善錯誤處理**
3. **加入安全標頭**

### 長期改善 (低優先級)
1. **實作安全監控**
2. **定期安全審計**
3. **加入威脅檢測**

---

## 📋 修復檢查清單

- [ ] 將 JWT 密鑰移至環境變數
- [ ] 實作資料庫連線加密
- [ ] 移除 Console.WriteLine 敏感資訊記錄
- [ ] 加入完整的輸入驗證
- [ ] 實作安全 HTTP 標頭
- [ ] 改善會話 Cookie 安全性
- [ ] 加入錯誤處理中間件
- [ ] 實作日誌記錄最佳實踐
- [ ] 加入安全監控和警報
- [ ] 定期進行安全測試

---

## 📊 風險評分

| 類別 | 風險等級 | 數量 |
|------|----------|------|
| 高風險 | 🔴 | 2 |
| 中風險 | 🟡 | 3 |
| 低風險 | 🟢 | 2 |
| **總計** | | **7** |

**整體風險評級**: 中高風險
**建議**: 立即修復高風險問題，並制定安全改善計劃
