# 使用者管理系統

## 1. 系統架構

### 1.1 技術架構
- **後端框架**: ASP.NET Core 8.0 MVC
- **資料庫**: Microsoft SQL Server
- **ORM**: Dapper
- **前端UI**: LTEAdmin 3.2 + Bootstrap 5
- **JavaScript庫**: jQuery, DataTables, Toastr, SweetAlert2
- **認證方式**: Cookie Authentication
- **密碼加密**: BCrypt.Net
- **角色管理**: 多選角色支援

### 1.2 專案結構
```
FriendlySeed/
├── Areas/
│   └── Admin/
│       ├── Controllers/
│       │   └── UserController.cs
│       └── Views/
│           └── User/
│               └── Index.cshtml
├── Models/
│   ├── User.cs
│   └── Role.cs
├── Services/
│   ├── IUserService.cs
│   ├── UserService.cs
│   ├── IRoleService.cs
│   └── RoleService.cs
└── wwwroot/
    └── js/
        └── admin.js
```

## 2. 功能需求

### 2.1 基本功能
- **使用者列表**: 顯示所有使用者，支援分頁、搜尋、排序
- **使用者新增**: 透過 Modal 彈出視窗新增使用者
- **使用者編輯**: 透過 Modal 彈出視窗編輯使用者
- **使用者刪除**: AJAX 刪除使用者
- **狀態切換**: 啟用/停用使用者狀態
- **密碼管理**: 系統產生6位數字亂數密碼

### 2.2 進階功能
- **Excel 匯出**: 匯出使用者列表為 Excel 檔案
- **多選角色**: 使用 Checkbox List 選擇多個角色
- **角色顯示**: 顯示對應的角色名稱而非角色ID
- **密碼變更**: 透過 SweetAlert2 變更密碼
- **即時驗證**: 表單即時驗證
- **訊息提示**: 使用 Toastr 顯示操作結果

### 2.3 權限控制
- **管理員認證**: 需要登入後台才能存取
- **操作記錄**: 記錄建立時間、更新時間
- **狀態管理**: 支援使用者啟用/停用狀態
- **角色關聯**: 支援多選角色權限

## 3. 資料表結構

### 3.1 User 資料表
```sql
CREATE TABLE [User] (
    ID INT IDENTITY(1,1) PRIMARY KEY,                    -- 使用者ID
    Username NVARCHAR(50) NOT NULL,                      -- 使用者名稱
    DisplayName NVARCHAR(100) NOT NULL,                  -- 顯示名稱
    Avatar NVARCHAR(500) NULL,                           -- 頭像路徑
    Description NVARCHAR(500) NULL,                      -- 描述
    RoleID NVARCHAR(500) NOT NULL,                       -- 角色ID (多選，逗號分隔)
    Email NVARCHAR(100) NOT NULL,                        -- 電子信箱
    Password NVARCHAR(255) NOT NULL,                     -- 密碼 (BCrypt加密)
    IsActive BIT NOT NULL DEFAULT 1,                     -- 是否啟用
    CreatedTime DATETIME2 DEFAULT GETDATE(),             -- 建立時間
    UpdatedTime DATETIME2 DEFAULT GETDATE(),             -- 更新時間
    UNIQUE (Username),
    UNIQUE (Email)
);
```

### 3.2 Role 資料表
```sql
CREATE TABLE [Role] (
    RoleID INT IDENTITY(1,1) PRIMARY KEY,                -- 角色ID
    RoleName NVARCHAR(50) NOT NULL,                      -- 角色名稱
    Description NVARCHAR(200) NULL,                      -- 角色描述
    IsActive BIT NOT NULL DEFAULT 1,                     -- 是否啟用
    CreatedTime DATETIME2 DEFAULT GETDATE(),             -- 建立時間
    UpdatedTime DATETIME2 DEFAULT GETDATE()              -- 更新時間
);
```

### 3.3 欄位說明
| 欄位名稱 | 資料類型 | 是否必填 | 預設值 | 說明 |
|---------|---------|---------|--------|------|
| ID | INT | 是 | IDENTITY(1,1) | 主鍵，自動遞增 |
| Username | NVARCHAR(50) | 是 | - | 使用者名稱 (唯一) |
| DisplayName | NVARCHAR(100) | 是 | - | 顯示名稱 |
| Avatar | NVARCHAR(500) | 否 | NULL | 頭像路徑 |
| Description | NVARCHAR(500) | 否 | NULL | 使用者描述 |
| RoleID | NVARCHAR(500) | 是 | - | 角色ID (多選，逗號分隔) |
| Email | NVARCHAR(100) | 是 | - | 電子信箱 (唯一) |
| Password | NVARCHAR(255) | 是 | - | 密碼 (BCrypt加密) |
| IsActive | BIT | 是 | 1 | 是否啟用 |
| CreatedTime | DATETIME2 | 否 | GETDATE() | 建立時間 |
| UpdatedTime | DATETIME2 | 否 | GETDATE() | 更新時間 |

## 4. 使用者介面需求

### 4.1 後台路徑
- **主要頁面**: `localhost:8054/Admin/User`
- **認證要求**: 需要管理員登入

### 4.2 介面元件
- **UI框架**: LTEAdmin 3.2 + Bootstrap 5
- **資料表格**: DataTables (繁體中文介面)
- **彈出視窗**: Bootstrap Modal
- **角色選擇**: Checkbox List
- **訊息提示**: Toastr
- **確認對話框**: SweetAlert2

### 4.3 功能按鈕
- **新增按鈕**: 開啟 Modal 新增使用者
- **編輯按鈕**: 開啟 Modal 編輯使用者
- **刪除按鈕**: AJAX 刪除使用者
- **狀態切換**: 啟用/停用使用者
- **密碼變更**: 變更使用者密碼
- **Excel匯出**: 匯出使用者列表

## 5. 驗收項目

### 5.1 基本功能驗收
- [ ] **使用者列表顯示**
  - [ ] 正確顯示所有使用者資料
  - [ ] 支援分頁功能 (每頁25筆)
  - [ ] 支援搜尋功能
  - [ ] 支援欄位排序
  - [ ] 顯示繁體中文介面
  - [ ] 角色欄位顯示角色名稱而非ID

- [ ] **使用者新增功能**
  - [ ] Modal 彈出視窗正常開啟
  - [ ] 表單驗證正常運作
  - [ ] 必填欄位驗證 (使用者名稱、顯示名稱、電子信箱、角色、密碼)
  - [ ] 字元長度限制驗證
  - [ ] 電子信箱格式驗證
  - [ ] 密碼確認驗證
  - [ ] 成功新增後顯示成功訊息
  - [ ] 新增後自動重新載入列表

- [ ] **使用者編輯功能**
  - [ ] Modal 彈出視窗正常開啟
  - [ ] 正確載入現有資料
  - [ ] 角色 Checkbox List 正確載入
  - [ ] 編輯時跳過密碼驗證
  - [ ] 表單驗證正常運作
  - [ ] 成功更新後顯示成功訊息
  - [ ] 更新後自動重新載入列表

- [ ] **使用者刪除功能**
  - [ ] 確認對話框正常顯示
  - [ ] 成功刪除後顯示成功訊息
  - [ ] 刪除後自動重新載入列表

### 5.2 進階功能驗收
- [ ] **角色管理功能**
  - [ ] Checkbox List 正確載入角色
  - [ ] 支援多選角色
  - [ ] 編輯時正確顯示已選角色
  - [ ] 角色名稱正確顯示在列表中
  - [ ] 無角色時顯示 "無角色"

- [ ] **密碼管理功能**
  - [ ] 新增時密碼為必填
  - [ ] 編輯時密碼欄位留空表示不修改
  - [ ] 密碼變更按鈕正常運作
  - [ ] 系統產生6位數字亂數密碼
  - [ ] 密碼變更後顯示新密碼
  - [ ] 密碼使用 BCrypt 加密

- [ ] **Excel 匯出功能**
  - [ ] 匯出按鈕正常顯示
  - [ ] 匯出檔案包含正確資料
  - [ ] 匯出欄位正確 (排除操作欄位)
  - [ ] 匯出檔案名稱正確

### 5.3 使用者體驗驗收
- [ ] **介面響應性**
  - [ ] Modal 點擊背景不關閉
  - [ ] Modal 右上角關閉圖示正常
  - [ ] 載入狀態正確顯示
  - [ ] 錯誤訊息正確顯示

- [ ] **訊息提示**
  - [ ] 成功操作顯示綠色 Toastr
  - [ ] 錯誤操作顯示紅色 Toastr
  - [ ] 訊息內容正確
  - [ ] 訊息自動消失

- [ ] **資料驗證**
  - [ ] 前端即時驗證
  - [ ] 後端手動驗證
  - [ ] 錯誤訊息正確顯示
  - [ ] 必填欄位標示清楚

### 5.4 效能驗收
- [ ] **載入效能**
  - [ ] 頁面載入時間 < 3秒
  - [ ] DataTable 初始化正常
  - [ ] AJAX 請求回應時間 < 2秒
  - [ ] 角色資料載入正常

- [ ] **資料處理**
  - [ ] 大量資料分頁正常
  - [ ] 搜尋功能效能良好
  - [ ] 排序功能正常運作
  - [ ] 角色名稱查詢效能良好

### 5.5 安全性驗收
- [ ] **權限控制**
  - [ ] 未登入無法存取頁面
  - [ ] 登入後正常存取功能
  - [ ] 操作權限正確

- [ ] **資料安全**
  - [ ] CSRF Token 驗證
  - [ ] 密碼加密儲存
  - [ ] SQL Injection 防護
  - [ ] XSS 防護
  - [ ] 電子信箱唯一性驗證
  - [ ] 使用者名稱唯一性驗證

## 6. 測試案例

### 6.1 功能測試
1. **新增使用者測試**
   - 輸入完整資料新增使用者
   - 輸入不完整資料測試驗證
   - 選擇多個角色測試
   - 密碼確認驗證測試
   - 電子信箱格式驗證測試

2. **編輯使用者測試**
   - 修改使用者基本資料
   - 修改角色選擇
   - 密碼欄位留空測試
   - 狀態切換測試

3. **密碼管理測試**
   - 新增時密碼必填測試
   - 編輯時密碼可選測試
   - 密碼變更功能測試
   - 新密碼顯示測試

4. **角色管理測試**
   - 單選角色測試
   - 多選角色測試
   - 角色名稱顯示測試
   - 無角色處理測試

### 6.2 介面測試
1. **Modal 測試**
   - 開啟/關閉 Modal
   - Modal 內容載入
   - 表單驗證顯示
   - Checkbox List 載入

2. **DataTable 測試**
   - 分頁功能
   - 搜尋功能
   - 排序功能
   - Excel 匯出

3. **角色選擇測試**
   - Checkbox List 顯示
   - 多選功能
   - 選中狀態保持
   - 清除功能

### 6.3 錯誤處理測試
1. **網路錯誤測試**
   - 網路中斷情況
   - 伺服器錯誤處理
   - 超時處理

2. **資料驗證測試**
   - 必填欄位測試
   - 字元長度測試
   - 電子信箱格式測試
   - 唯一性驗證測試

3. **密碼安全測試**
   - 密碼加密測試
   - 密碼變更測試
   - 密碼強度測試

## 7. 部署說明

### 7.1 環境需求
- .NET 8.0 Runtime
- Microsoft SQL Server
- IIS 或 Kestrel

### 7.2 設定檔
- `appsettings.json`: 資料庫連線字串
- `Program.cs`: 服務註冊和中介軟體設定

### 7.3 資料庫設定
- 執行 `update_user_table.sql` 修改 User 表結構
- 確保 Role 表有基本角色資料
- 設定適當的資料庫權限

### 7.4 安全設定
- 設定強密碼政策
- 定期更新密碼
- 監控使用者活動
- 備份使用者資料

## 8. 維護說明

### 8.1 定期維護
- 檢查使用者活動日誌
- 清理無效使用者帳號
- 更新角色權限
- 備份使用者資料

### 8.2 故障排除
- 密碼變更失敗處理
- 角色載入錯誤處理
- 資料驗證錯誤處理
- 權限問題處理

### 8.3 效能優化
- 角色查詢優化
- 大量使用者資料處理
- 搜尋功能優化
- 快取機制實作
